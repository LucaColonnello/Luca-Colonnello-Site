module.exports = (function( ){
	// call mysql
	var mysql = require('mysql');

	// this object
	var self = {};
	var _connection = false;
	
	// connect
	self.connect = function(){
		if ( _connection ) return true;
		
		// mysql connection
		if( process.env.NODE_ENV == "development" )
			_connection = mysql.createConnection({
			  host     : global.config.db_host,
			  user     : global.config.db_user,
			  password : global.config.db_password,
			  database : global.config.db_name
			});
		else
			_connection = mysql.createConnection({
			  host     : process.env.OPENSHIFT_MYSQL_DB_HOST,
			  port     : process.env.OPENSHIFT_MYSQL_DB_PORT,
			  user     : process.env.OPENSHIFT_MYSQL_DB_USERNAME,
			  password : process.env.OPENSHIFT_MYSQL_DB_PASSWORD,
			  database : process.env.OPENSHIFT_GEAR_NAME
			});
	};
	
	// query
	self.query = function( sql, data, callback_s, callback_e, log ){
		// check sql
		if( !sql ) {
			callback_e( error.no_sql, false );
		}
		
		// open connection
		self.connect();
		
		// default data
		data = data || false;
		
		// connect
		_connection.connect(function(err) {
			// connected! (unless `err` is set)
			if( err ) {
				callback_e( error.err_connect, err );
				_connection = false;
				return;
			}
			
			var query = _connection.query(sql, data, function(err, result) {
				if( err ) {
					callback_e( error.err_query, err );
				} else {
					// callback success
					callback_s( result );
				}
				
				_connection.end();
				_connection = false;
			} );
			
			if( log ) {
				console.log(query.sql);
			}
		});
	};
	
	// error
	var error = {
		'no_sql': 'Nessuna query passata.',
		'err_connect': 'Errore connessione database.',
		'err_query': 'Errore nella query.'
	};
	
	return self;
})( );